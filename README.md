# BiliFAV - B站收藏夹视频下载工具

![GitHub release (latest by date)](https://img.shields.io/github/v/release/Qtgcy08/biliFAV?style=flat-square)
![Python Version](https://img.shields.io/badge/python-3.10+-blue?style=flat-square)
![License](https://img.shields.io/badge/license-AGPL--3.0-orange?style=flat-square)

> **免责声明**：本项目仅供学习交流使用，禁止用于商业用途。使用者需自行承担所有法律责任。

BiliFAV是一个功能强大的命令行工具，用于下载Bilibili收藏夹中的视频内容。通过扫码登录B站账号，用户可以轻松下载自己收藏的视频，支持多种清晰度选择和后台合并功能。

## ✨ 功能特点

- 🔑 扫码登录B站账号
- 📂 列出用户所有收藏夹
- ⬇️ 下载指定收藏夹的全部视频
- 🎚️ 支持多种清晰度选择（4K、1080P60、1080P+等）
- 🔀 自动合并音视频流（需要FFmpeg）
- 🚀 断点续传和跳过已下载文件
- ⏯️ 支持覆盖或跳过已存在文件
- 💾 数据库缓存收藏夹信息，减少API请求
- 🎯 支持直接下载单个视频（通过BV号或链接）
- 📁 多分P视频智能处理

## 🚀 快速开始

### 下载预编译版本（推荐）

1. 前往 [Release页面](https://github.com/Qtgcy08/biliFAV/releases/tag/Stable) 下载对应平台的预编译版本
2. 解压后运行可执行文件：
   - Windows: `biliFAV_win_x64_版本号.exe`
   - 其他平台：从源码运行

### 从源码运行

```bash
# 克隆仓库
git clone https://github.com/Qtgcy08/biliFAV.git
cd biliFAV

# 安装依赖
uv sync

# 运行程序
uv run python biliFAV.py
```

## 📋 必需依赖：FFmpeg

BiliFAV需要FFmpeg来合并高清晰度视频的音视频流。

### Windows安装FFmpeg

1. 访问 [Gyan.dev FFmpeg Builds](https://www.gyan.dev/ffmpeg/builds/ffmpeg-git-full.7z) 下载完整版
2. 解压到 `C:\ffmpeg`
3. 将 `C:\ffmpeg\bin` 添加到系统PATH环境变量
4. 验证安装：`ffmpeg -version`

### macOS安装

```bash
brew install ffmpeg
```

### Linux安装

```bash
# Ubuntu/Debian
sudo apt update && sudo apt install ffmpeg

# Fedora
sudo dnf install ffmpeg

# Arch Linux
sudo pacman -S ffmpeg
```

## 📖 详细使用指南

### 1. 程序启动和初始化

首次运行程序时，会自动进行初始化检查，包括：
- FFmpeg安装状态检测
- 登录状态验证
- 会员权限检查
- 后台合并线程启动

### 2. 主菜单操作

程序提供简洁的主菜单界面：
- 下载收藏夹视频
- 直接下载单个视频
- 退出程序

### 3. 收藏夹下载流程

#### 3.1 收藏夹数据管理
- 自动检测本地数据库缓存
- 可选择更新或使用缓存数据
- 减少API请求，提高运行效率

#### 3.2 收藏夹列表显示
- 树状结构展示所有收藏夹
- 显示收藏夹名称、视频数量和ID
- 支持大量收藏夹的快速浏览

#### 3.3 选择下载选项
- 输入收藏夹ID进行选择
- 多种清晰度选项（4K到360P）
- 自定义下载路径设置

### 4. 文件处理选项

#### 4.1 已存在文件处理
提供灵活的覆盖选项：
- 跳过当前文件
- 覆盖当前文件
- 覆盖所有文件
- 跳过所有文件
- 取消下载

#### 4.2 多分P视频处理
- 自动检测多分P视频
- 显示所有分P列表和状态
- 支持多种选择模式：
  - 下载所有分P
  - 下载指定分P
  - 仅下载未存在分P

### 5. 下载统计和进度

#### 5.1 下载前统计
显示详细的下载任务统计：
- 跳过文件数量
- 覆盖文件数量
- 新增文件数量
- 总计需要下载数量

#### 5.2 下载完成统计
提供完整的下载结果汇总：
- 成功下载数量
- 失败下载数量
- 跳过文件数量
- 新增文件数量

### 6. 直接下载模式

支持多种视频链接格式：
- BV号格式
- 完整视频链接
- 短链接格式

### 7. 后台合并功能

智能音视频处理：
- 自动检测视频格式
- 后台异步合并处理
- 不影响下载速度
- 支持断点续传

## ⚙️ 高级功能

### 文件覆盖选项

当文件已存在时，程序会询问处理方式：
- 覆盖此文件
- 跳过此文件
- 覆盖所有文件
- 跳过所有文件

### 批量操作

- **覆盖所有**：一次性覆盖所有已存在文件
- **跳过所有**：一次性跳过所有已存在文件
- **中断下载**：按 `Ctrl+C` 可随时中断下载

### 数据库缓存

程序使用SQLite数据库缓存收藏夹信息：
- 数据库文件：`.get_my_favourite.sqlite`
- 自动更新：可手动选择是否更新缓存
- 减少API请求：提高程序运行效率

## 🔧 配置说明

### 配置文件

程序运行后生成的文件：
- `bili_token.toml` - 登录token，避免重复扫码
- `.get_my_favourite.sqlite` - 收藏夹数据缓存

### 安全提醒

**重要安全注意事项**：

1. **Token文件保护**：
   - `bili_token.toml` 文件包含您的B站登录凭证
   - 请勿将此文件分享给他人或在公共场合泄露
   - 定期检查文件权限，确保只有您能访问

2. **数据安全**：
   - 收藏夹数据缓存文件包含您的收藏信息
   - 建议定期备份重要数据
   - 在公共计算机上使用后请及时删除相关文件

3. **账号安全**：
   - 如发现异常登录行为，请立即删除token文件重新登录
   - 建议定期更换密码以增强账号安全性
   - 避免在不可信的设备上使用本工具

### 重新登录

如需重新登录，删除 `bili_token.toml` 文件即可。建议在以下情况下重新登录：
- 更换使用设备
- 发现账号异常
- 长时间未使用后重新启用

## 🛠️ 技术实现

BiliFAV基于以下技术构建：

- Python 3.10+ 异步编程
- HTTPX 高性能HTTP客户端
- SQLite 轻量级数据库
- FFmpeg 音视频处理
- TOML 配置文件格式

项目结构遵循模块化设计原则，主要模块包括：

- 认证模块：处理扫码登录和token管理
- API模块：封装Bilibili接口调用
- 下载模块：实现多线程下载和进度显示
- 合并模块：后台音视频流合并
- 数据库模块：收藏夹数据缓存

## ❓ 常见问题

### Q: 程序启动时显示"FFmpeg检测成功"但版本号不同？
A: 这是正常的，程序会自动检测系统中安装的FFmpeg版本。只要显示"检测成功"即可正常使用。

### Q: 收藏夹显示"获取不完整"是什么意思？
A: 这表示API返回的数据不完整，可能由于网络问题或B站API限制。程序会继续处理可用的数据。

### Q: 多分P视频中的"✅"标记是什么意思？
A: "✅"标记表示该分P视频文件已经存在，可以选择跳过或覆盖。

### Q: 下载过程中如何中断？
A: 按 `Ctrl+C` 可以优雅中断下载，程序会保存当前进度。

### Q: 为什么有些视频下载后需要合并？
A: 高清晰度视频使用DASH格式，音视频流分开下载，需要FFmpeg合并。360P及以下使用FLV格式无需合并。

### Q: 如何重新登录账号？
A: 删除 `bili_token.toml` 文件，下次运行程序时会重新要求扫码登录。

### Q: 数据库文件可以删除吗？
A: 可以删除 `.get_my_favourite.sqlite` 文件，但下次运行需要重新获取收藏夹数据。

### Q: 下载失败的文件会重试吗？
A: 程序会记录失败的文件，可以在下次运行时重新尝试下载。

### Q: 大会员视频无法下载高清晰度？
A: 确保使用大会员账号登录，且token未过期。非大会员最高可下载1080P（代码80）。

### Q: 文件合并失败？
A: 检查FFmpeg安装，确保PATH环境变量设置正确。程序需要FFmpeg来合并DASH格式的音视频流。

## ⚠️ 注意事项

### 技术限制
1. **必须安装FFmpeg** 才能下载高清晰度视频（360P以上）
2. 大会员账号可以下载4K等高分辨率视频
3. 非大会员账号最高可下载1080P（代码80）
4. 程序使用异步下载，支持断点续传

### 使用规范
5. 请合理使用，避免过度下载导致账号异常
6. 下载的视频仅供个人学习使用
7. 尊重视频创作者版权，禁止商业用途
8. 建议在良好网络环境下使用，避免频繁中断

### 文件处理
9. 文件名会自动清理非法字符，但保留emoji表情
10. 文件名长度限制为180字符，超长会自动截断
11. 下载路径中会自动创建收藏夹名称的子文件夹
12. 支持批量操作（覆盖所有/跳过所有）提高效率

### 数据缓存
13. 登录token保存在 `bili_token.toml`，删除可强制重新登录
14. 收藏夹数据缓存在 `.get_my_favourite.sqlite`，可手动更新
15. 数据库会自动升级结构，添加 `last_updated` 字段

## 📝 版本说明

### 特殊版本号含义
- **7.12.1** - 洛天依生日彩蛋版本 (7.12生日 + "1"依)
- **5.21.x** - "我爱依"系列版本

### 编译版本管理
程序使用 `auto_complainer.py` 自动管理版本号：
- 版本号存储在 `complainer_count.txt`
- 每次编译自动递增版本
- 使用Nuitka打包，启用LTO优化
- 设置Windows文件属性信息

### 依赖管理
- 使用 `uv` 管理Python环境和依赖
- 配置中国镜像源加速下载
- 核心依赖：aiohttp, httpx, tqdm, qrcode

## 📚 相关文档

- [开发文档](DEVELOPMENT.md) - 开发者和贡献者指南
- [API参考](API_REFERENCE.md) - 内部和外部API接口说明
- [故障排除](TROUBLESHOOTING.md) - 常见问题解决方案
- [程序流程图](flowchart.md) - 完整的程序逻辑流程图

## 📄 法律免责声明

1. 本项目与哔哩哔哩(bilibili)无任何关联
2. 使用的API来自第三方逆向工程，存在法律风险
3. **禁止用于商业用途**，仅限个人学习研究
4. 使用者需自行承担所有法律责任
5. 项目作者不承担因滥用导致的侵权责任

## 🙏 参考项目

- [bilibili-API-collect](https://github.com/SocialSisterYi/bilibili-API-collect) - 哔哩哔哩API收集整理

## 👤 作者

依轨泠QTY
B站主页: [https://space.bilibili.com/3461567223957589](https://space.bilibili.com/3461567223957589)
GitHub: [https://github.com/Qtgcy08](https://github.com/Qtgcy08)

## 📄 开源许可

本项目采用AGPL-3.0许可证。详情请见LICENSE文件。

---

**温馨提示**：请合理使用本工具，尊重视频创作者和平台权益。过度下载可能导致账号异常或被限制访问。
